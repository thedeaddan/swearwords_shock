<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>Speech Recognition</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
</head>
<body>
    <h1>Speech Recognition</h1>
    <button id="startButton" onclick="startStream()">Start Stream</button>
    <button id="stopButton" onclick="stopStream()">Stop Stream</button>
    <div id="result"></div>

    <script>
        let recognition;

        function startStream() {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.maxDuration = 5000; // 5 seconds
            console.log("1");

            recognition.onresult = function(event) {
                let result = event.results[event.results.length - 1][0].transcript;
                console.log(result);
                $('#result').text(result);
                console.log("1111");
                sendToServer(result);
            };

            recognition.onend = function() {
                startStream(); // Restart recognition after it ends
            };

            recognition.start();
            $('#result').text('Stream started');
        }

        function stopStream() {
            if (recognition) {
                recognition.stop();
                $('#result').text('Stream stopped');
            }
        }
        function shock(){
            console.log("1");
            var formData = new FormData();
            formData.append('time', 1);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://192.168.4.1/shock', true);
            xhr.onload = function() {
                console.log(xhr.responseText);
            };
            xhr.send(formData);
        }
        function sendToServer(data) {
            $.ajax({
                type: 'POST',
                url: '/receive_text',
                data: {'text': data},
                success: function(response) {
                    handleResponse(response);
                },
                error: function(error) {
                    console.error('Error sending data to server:', error);
                }
            });
        }

        function handleResponse(response) {
            if (response.status) {
                shock();
                $('#result').text('МАТ НАЙДЕН!');
                $('body').addClass('found-animation');
                setTimeout(function() {
                    $('body').removeClass('found-animation');
                    $('#result').text('');
                }, 3000);
            } else {
                $('#result').text(response.text);
            }
        }
    </script>
</body>
</html>
