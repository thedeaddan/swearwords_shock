<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <title>Шокирующий мат</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
</head>

<body>
    <h1>Шокирующий мат</h1>
    <h3>Включение проверки</h3>
    <label class="switch">
        <input type="checkbox" id="toggleStream" onchange="toggleStream()">
        <span class="slider"></span>
    </label>
    <h4>Я услышал:</h4>
    <div id="result"></div>

    <script>
        let recognition;
        let isRecognitionRunning = false;

        function startStream() {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.maxDuration = 1000; // 5 seconds

            recognition.onresult = function(event) {
                let result = event.results[event.results.length - 1][0].transcript;
                $('#result').text(result);
                sendToServer(result);
            };

            recognition.onend = function() {
                if (isRecognitionRunning) {
                    startStream(); // Restart recognition only if it's supposed to be running
                }
            };

            recognition.start();
            isRecognitionRunning = true;
            $('#result').text('Пока ничего, я вас слушаю..');
        }

        function stopStream() {
            recognition.stop();
            isRecognitionRunning = false;
            $('#result').text('Увы я вас больше не услышу..');
        }
        function toggleStream() {
            if ($('#toggleStream').prop('checked')) {
                startStream();
            } else {
                stopStream();
            }
        }

        function shock() {
            var formData = new FormData();
            formData.append('time', 1);
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://192.168.4.1/shock', true);
            xhr.send(formData);
        }
        function sendToServer(data) {
            $.ajax({
                type: 'POST',
                url: '/receive_text',
                data: {'text': data},
                success: function(response) {
                    handleResponse(response);
                },
                error: function(error) {
                    console.error('Error sending data to server:', error);
                }
            });
        }

        function handleResponse(response) {
            if (response.status) {
                shock();
                $('#result').text('МАТ!');
                $('body').addClass('found-animation');
                setTimeout(function() {
                    $('body').removeClass('found-animation');
                    $('#result').text('');
                }, 3000);
            } else {
                $('#result').text(response.text);
            }
        }
    </script>
</body>
</html>
